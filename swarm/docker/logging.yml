version: '3.5'

services:
  telegraf:
    image: telegraf:latest
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]
      restart_policy:
        condition: on-failure
        max_attempts: 3
    depends_on:
    - influxdb
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - telegraf_config:/etc/telegraf
    networks:
    - common

  cadvisor:
    image: google/cadvisor
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]
      restart_policy:
        condition: on-failure
        max_attempts: 3
    hostname: '{{.Node.Hostname}}'
    command: -logtostderr -docker_only -storage_driver=influxdb -storage_driver_db=cadvisor -storage_driver_host=influxdb:8086
    volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro
    networks:
    - common

  grafana:
    image: grafana/grafana:latest
    deploy:
      replicas: 1
      placement:
        constraints:
        - node.platform.arch == x86_64
      restart_policy:
        condition: on-failure
        max_attempts: 3
    ports:
    - 3000:3000
    volumes:
    - grafana_data:/var/lib/grafana
    environment:
    - GF_INSTALL_PLUGINS=ntop-ntopng-datasource,grafana-piechart-panel,grafana-worldmap-panel
    - GF_SECURITY_ALLOW_EMBEDDING=true
    - GF_AUTH_ANONYMOUS_ENABLED=true
    - GF_AUTH_ANONYMOUS_ORG_NAME=Yardnet
    networks:
    - common

  influxdb:
    image: influxdb:latest
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
      placement:
        constraints:
        - node.platform.arch == x86_64
      resources:
        limits:
          memory: 2048M
    ports:
    - 8086:8086
    - 2003:2003
    volumes:
    - influxdb_config:/etc/influxdb
    - influxdb_data:/var/lib/influxdb
    networks:
    - common

  logstash:
    image: threesquared/logstash:x86
    deploy:
      replicas: 1
      placement:
        constraints:
        - node.platform.arch == x86_64
      restart_policy:
        condition: on-failure
        max_attempts: 3
    ports:
    - 5140:5140
    - 5140:5140/udp
    volumes:
    - logstash_config:/usr/share/logstash/config
    - logstash_pipeline:/usr/share/logstash/pipeline
    networks:
    - common

volumes:
  telegraf_config:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/telegraf"
  influxdb_config:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/influxdb/config"
  logstash_config:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/logstash/config"
  logstash_pipeline:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/logstash/pipeline"
  grafana_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/grafana"
  influxdb_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.0.3,nolock,soft,rw
      device: ":/mnt/RAIDZ/Docker/influxdb/data"

networks:
  common:
    external: true
